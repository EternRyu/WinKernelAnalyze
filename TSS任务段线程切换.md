# TSS 任务状态段描述符
​ TSS（Task State Segment）任务状态段描述符用于描述保存任务重要信息的系统段，权限发生变化要借用TSS。任务状态段寄存器TR的可见部分为当前任务状态段描述符的选择子，不可见部分是当前任务状态段的段基地址和段界限等信息，TR只装载一次，TR.Base指向的地址即TSS

如何调用TSS:</br>
CPU中有一个TR段寄存器,存出一个段描述符,存在于GDT段描述符表中,属于系统段描述符的一种,base指向TSS表的地址,limit表示他的偏移范围

操作系统通过TSS实现任务的挂起和恢复，在切换任务的过程中，处理器中的各寄存器的当前值会
被自动地保存到TR指定的TSS中，接着下一个任务的TSS的选择子被装入TR，最后从TR所指定的TSS中取出各寄存器的值送到处理器的各寄存器中。

>当使用 call/jmp + TSS段选择子的时候，CPU做了以下几件事情。
>
>把当前所有寄存器（TSS结构中有的那些寄存器）的值填写到当前 tr 段寄存器指向的 TSS 中</br>
把新的 TSS 段选择子指向的段描述符加载到 tr 段寄存器中</br>
把新的 TSS 段中的值覆盖到当前所有寄存器（TSS结构中有的那些寄存器）中</br>


![alt text](ImageFile\Task-StateSegment(TSS).png)



ESP0-ESP2对应0环-2环的ESP，由于SS跟ESP相对应，所以SS段也相同

CR3：每一个进程都有一个CR3，里面存的是页目录表基址，为物理地址

LDT：局部描述符表

链接字段：安排在TSS 0偏移处，其中高16位未使用，低16位保存前一任务的TSS选择子


Intel设计TSS的目的是为了任务切换(线程切换),但Windows与Linux , 并没有使用。而是采用堆栈来保存线程的各种寄存器


### X64变化
![alt text](ImageFile\IST.png)

###  IST Field

中断门和陷阱门中多了个IST

![alt text](ImageFile\64-BitIDTGateDescriptors.png)


IST字段（中断和陷阱门）。比特2:0的字节+4。长模式中断门和陷阱门描述符包含一个新的3位中断堆栈表（IST）字段，在旧的门描述符中不存在。

IST字段用作长模式TSS的IST部分的索引。如果IST字段不为0，则索引引用TSS中的IST指针，当中断发生时处理器将其加载到RSP寄存器中。如果IST索引为0，则处理器在中断发生时使用遗留的堆栈切换机制（经过一些修改）。更多信息请参见第284页的“中断堆栈表”。


这个数是1，内核栈就用IST1